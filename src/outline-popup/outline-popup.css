/* ----------------------------------------------- */
/* **** SECTION: Notion-like Floating Outline **** */
/* ----------------------------------------------- */

/* Theme tokens */
:root {
  --outline-bg: #ffffff;
  --outline-fg: #73726e;               /* item text (inactive) */
  --outline-fg-strong: #32302c;        /* item text (active) */
  --outline-accent: #2383e2;           /* link/active accent */
  --outline-border: rgba(84, 72, 49, 0.08);
  --outline-rail-muted: rgba(84, 72, 49, 0.15);
  --outline-rail-active: rgb(50, 48, 44);
  --outline-shadow-1: rgba(0, 0, 0, 0.1) 0 14px 28px -6px;
  --outline-shadow-2: rgba(0, 0, 0, 0.06) 0 2px 4px -1px;
  --outline-z: 999;
  --outline-card-radius: 14px;
  --outline-popup-width: 260px;
  --outline-rail-width: 56px;
  --outline-rail-gap: 12px;
  --outline-rail-pad-right: 8px;
  --outline-rail-bar-height: 2px;
  --outline-popup-pad-x: 12px;
  --outline-popup-pad-top: 12px;
  --outline-popup-max-h: min(80vh, 765px);
  --outline-popup-right-offset: 8px;   /* nudge left so right border/shadow remain visible */

  --outline-hover-bg: rgba(55, 53, 47, 0.08);
  --outline-scrollbar-thumb: rgba(0, 0, 0, 0.2);
  --outline-scrollbar-thumb-hover: rgba(0, 0, 0, 0.28);

  /* Vertical positioning defaults; JS sets --outline-top dynamically to follow title until sticky baseline */
  --outline-sticky-top: 151px; /* site-specific sticky baseline (nav 60 + margin 48 + title 48) */
  /* --outline-top is set dynamically at runtime; if absent, fall back to sticky top */
}

.dark-mode {
  --outline-bg: #1f1f1f;
  --outline-fg: #a5a39e;
  --outline-fg-strong: #e6e4df;
  --outline-accent: #6aa9ff;
  --outline-border: rgba(255, 255, 255, 0.12);
  --outline-rail-muted: rgba(255, 255, 255, 0.22);
  --outline-rail-active: #e6e4df;

  /* New: dark-mode hover + scrollbar colors */
  --outline-hover-bg: rgba(255, 255, 255, 0.08);
  --outline-scrollbar-thumb: rgba(255, 255, 255, 0.18);
  --outline-scrollbar-thumb-hover: rgba(255, 255, 255, 0.26);
}

/* Right rail: compact document map */
.bullet-outline-rail {
  position: fixed;
  z-index: var(--outline-z);
  inset-inline-end: 0;
  top: var(--outline-top, var(--outline-sticky-top));
  width: var(--outline-rail-width);
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  transition: opacity 0.12s ease;
  pointer-events: auto; /* interactive */
}

.bullet-outline-rail-bars {
  display: flex;
  flex-direction: column;
  gap: var(--outline-rail-gap);
  padding-inline-end: var(--outline-rail-pad-right);
  padding-bottom: 12px;
}

.bullet-outline-bar {
  height: var(--outline-rail-bar-height);
  background-color: var(--outline-rail-muted);
  border-radius: 2px;
  transition: background 0.2s ease, box-shadow 0.2s ease;
}

/* Width + indent by level (approximate Notion look) */
.bullet-outline-bar.level-1 { width: 16px; margin-inline-start: 0; }
.bullet-outline-bar.level-2 { width: 12px; margin-inline-start: 4px; }
.bullet-outline-bar.level-3 { width: 8px;  margin-inline-start: 8px; }

/* Active bar emphasizes current section */
.bullet-outline-bar.active {
  background-color: var(--outline-rail-active);
}

/* Popup container (hidden by default; shown via .open class) */
.bullet-outline-popup {
  position: fixed;
  z-index: calc(var(--outline-z) + 1);
  inset-inline-end: var(--outline-popup-right-offset);
  top: var(--outline-top, var(--outline-sticky-top));
  width: var(--outline-popup-width);
  /* Ensure popup never extends below viewport: cap by remaining space below dynamic top */
  max-height: min(
    var(--outline-popup-max-h),
    calc(100vh - var(--outline-top, var(--outline-sticky-top)) - 12px)
  );
  background-color: var(--outline-bg);
  color: var(--outline-fg);
  border-radius: var(--outline-card-radius);
  box-shadow: var(--outline-shadow-1), var(--outline-shadow-2), var(--outline-border) 0 0 0 1px;
  overflow: auto;
  /* Prevent scroll chaining to page when reaching top/bottom */
  overscroll-behavior: contain;
  display: none;
  pointer-events: auto; /* interactive */

  /* Subtle, theme-aware scrollbar (Firefox + generic) */
  scrollbar-width: thin;
  scrollbar-color: var(--outline-scrollbar-thumb) transparent;
}

/* Visible when JS toggles it */
.bullet-outline-popup.open {
  display: block;
}

/* Close button is hidden by default; shown only on touch/coarse media */
.bullet-outline-close {
  display: none;
}

/* Fullscreen presentation for touch/coarse devices */
body.dsbullet-mobile-popup {
  /* Expand popup to cover viewport; keep same DOM and behavior */
  .bullet-outline-popup.open {
    inset: 0;
    top: 0;
    inset-inline: 0;
    width: 100vw;
    height: 100vh; /* fallback for browsers without dvh */
    max-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* Close button (only visible on touch/coarse) */
  .bullet-outline-close {
    display: inline-flex;
    flex: 0 0 auto;
    align-items: center;
    justify-content: center;
    align-self: flex-end;
    appearance: none;
    border: none;
    margin: 8px;
    font-size: 26px;
    line-height: 1;
    width: 44px;
    height: 44px;
    border-radius: 8px;
    cursor: pointer;
  }
  .bullet-outline-close:focus-visible {
    outline: 2px solid var(--outline-accent);
  }

  /* Make the list fill and scroll within fullscreen */
  .bullet-outline-list {
    /* Slightly larger paddings for comfortable reading */
    padding: 8px var(--outline-popup-pad-x) 12px var(--outline-popup-pad-x);
    flex: 0 0 auto; /* don't sqish items, scroll instead */
    overflow: auto;
    /* Add a bit of separation between items for touch */
    gap: 4px;
  }

  /* Hide the rail while modal list is open on touch devices */
  .bullet-outline-rail:has(+ .bullet-outline-popup.open) {
    opacity: 0;
    pointer-events: none;
  }

  /* Larger, accessible tap targets in fullscreen */
  .bullet-outline-item {
    padding: 10px 12px; /* ~44px target with title line-height below */
    min-height: 44px;   /* iOS HIG minimum */
  }

  /* Larger, more legible titles on mobile */
  .bullet-outline-item .title {
    font-size: clamp(16px, 4.4vw, 18px);
    line-height: 1.4;
  }
}

/* Prefer dynamic viewport units when available (accounts for mobile browser UI) */
@supports (height: 100dvh) {
  /* Non-fullscreen popup sizing should also respect dynamic viewport */
  .bullet-outline-popup {
    max-height: min(
      var(--outline-popup-max-h),
      calc(100dvh - var(--outline-top, var(--outline-sticky-top)) - 12px)
    );
  }

  body.dsbullet-mobile-popup .bullet-outline-popup.open {
    height: 100dvh;
    max-height: 100dvh;
  }
}

/* Prevent background scroll when popup is open */
html:has(body.dsbullet-mobile-popup .bullet-outline-popup.open),
body.dsbullet-mobile-popup:has(.bullet-outline-popup.open) {
  overflow: hidden;
  /* Allow pinch-zoom while preventing background page panning */
  touch-action: pinch-zoom;
}


/* When popup is open, fade the rail out (Notion-like) */
.bullet-outline-rail:has(+ .bullet-outline-popup.open) {
  opacity: 0;
}

/* Inner list */
.bullet-outline-list {
  padding: var(--outline-popup-pad-top) var(--outline-popup-pad-x) 6px var(--outline-popup-pad-x);
  display: flex;
  flex-direction: column;
  gap: 1px;
}

/* Item link */
.bullet-outline-item {
  display: block;
  color: var(--outline-fg);
  text-decoration: none;
  user-select: none;
  cursor: pointer;
  padding: 4px;
  transition: color 0.15s ease, background-color 0.15s ease;
  border-radius: 8px;
}

/* clamp to two lines */
.bullet-outline-item .title {
  display: -webkit-box;
  -webkit-box-orient: vertical;
  overflow: hidden;
  -webkit-line-clamp: 2;
  line-clamp: 2;
  line-height: 1.3;
  font-size: 13px;
}

/* Indentation by level */
.bullet-outline-item.level-1 { margin-inline-start: 0;    }
.bullet-outline-item.level-2 { margin-inline-start: 12px; }
.bullet-outline-item.level-3 { margin-inline-start: 24px; }

/* Active/current section in popup */
.bullet-outline-item.active {
  color: var(--outline-accent);
  background-color: transparent;
}

/* Hover/focus (gray background; don't change text color) */
.bullet-outline-item:hover,
.bullet-outline-item:focus {
  background-color: var(--outline-hover-bg);
  outline: none;
}

/* Accessibility focus ring */
.bullet-outline-item:focus-visible {
  outline: 2px solid var(--outline-accent);
  background: transparent;
}

/* Allow on smallest viewports (no hiding by breakpoint).
   If needed later, we can add a compact density mod. */

/* Reduced motion considerations */
@media (prefers-reduced-motion: reduce) {
  .bullet-outline-bar,
  .bullet-outline-item {
    transition: none;
  }
}

/* Utility: hidden state if outline not applicable (e.g., too few headings) */
.bullet-outline-hidden {
  display: none !important;
}
/* Dark-mode specific active item styling in popup (Notion-like "pill") */
.dark-mode .bullet-outline-item.active:hover,
.dark-mode .bullet-outline-item.active:focus {
  background-color: rgba(255, 255, 255, 0.14);
}

/* WebKit scrollbar styling for the popup (theme-aware via CSS variables) */
.bullet-outline-popup::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}
.bullet-outline-popup::-webkit-scrollbar-track {
  background: transparent;
}
.bullet-outline-popup::-webkit-scrollbar-thumb {
  background-color: var(--outline-scrollbar-thumb);
  border-radius: 8px;
  border: 2px solid transparent; /* creates padding for the thumb */
  background-clip: padding-box;
}
.bullet-outline-popup::-webkit-scrollbar-thumb:hover {
  background-color: var(--outline-scrollbar-thumb-hover);
}

/* ---------------------------------------------- */
/* **** END OF: Notion-like Floating Outline **** */
/* ---------------------------------------------- */
