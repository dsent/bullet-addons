/* ----------------------------------------------- */
/* **** SECTION: Notion-like Floating Outline **** */
/* ----------------------------------------------- */

/* Theme tokens */
:root {
  --outline-bg: #ffffff;
  --outline-fg: #73726e; /* item text (inactive) */
  --outline-accent: #2383e2; /* link/active accent */
  --outline-border: rgba(84, 72, 49, 0.08);
  --outline-rail-muted: rgba(84, 72, 49, 0.15);
  --outline-rail-active: rgb(50, 48, 44);
  --outline-shadow-1: rgba(0, 0, 0, 0.1) 0 14px 28px -6px;
  --outline-shadow-2: rgba(0, 0, 0, 0.06) 0 2px 4px -1px;
  --outline-z: 999;
  --outline-focus-width: 2px;
  --outline-focus-outline: var(--outline-focus-width) solid var(--outline-accent);
  --outline-card-radius: 14px;
  --outline-popup-width: 260px;
  --outline-rail-width: 56px;
  --outline-rail-gap: 12px;
  --outline-rail-pad-right: 8px;
  --outline-rail-bar-height: 2px;
  --outline-rail-bar-full-width: 16px;
  --outline-popup-pad-x: 12px;
  --outline-popup-pad-top: 12px;
  --outline-popup-pad-bottom: 6px;
  --outline-popup-pad-bottom-mobile: 12px;
  --outline-popup-max-h: min(80vh, 765px);
  --outline-popup-gap: 1px;
  --outline-popup-gap-mobile: 4px;
  --outline-popup-right-offset: 8px; /* nudge left so right border/shadow remain visible */
  --outline-item-font-size: 13px;
  --outline-item-border-radius: 8px;
  --outline-item-padding: 4px;
  --outline-item-padding-mobile: 10px 12px; /* larger tap target on mobile */
  --outline-level-indent: 12px;

  --outline-hover-bg: rgba(55, 53, 47, 0.08);
  --outline-scrollbar-thumb: rgba(0, 0, 0, 0.2);
  --outline-scrollbar-thumb-hover: rgba(0, 0, 0, 0.28);

  --outline-rail-tab-radius: 4px;
  --outline-rail-border-w: 2px;
  --outline-rail-fill: transparent;
  --outline-rail-fill-hover: color-mix(in oklab, currentColor 9%, transparent);
  --outline-rail-border-color: transparent;
  --outline-rail-border-color-hover: color-mix(in oklab, currentColor 28%, transparent);

  /* Vertical positioning defaults; JS sets --outline-top dynamically to follow title until sticky baseline */
  /* --outline-top is set dynamically at runtime; if absent, fall back to sticky top */
  --outline-sticky-top: 151px; /* site-specific sticky baseline (nav 60 + margin 48 + title 48) */
}

.dark-mode {
  --outline-bg: #1f1f1f;
  --outline-fg: #a5a39e;
  --outline-accent: #6aa9ff;
  --outline-border: rgba(255, 255, 255, 0.12);
  --outline-rail-muted: rgba(255, 255, 255, 0.22);
  --outline-rail-active: #e6e4df;

  /* New: dark-mode hover + scrollbar colors */
  --outline-hover-bg: rgba(255, 255, 255, 0.08);
  --outline-scrollbar-thumb: rgba(255, 255, 255, 0.18);
  --outline-scrollbar-thumb-hover: rgba(255, 255, 255, 0.26);
}

/* Right rail: compact document map */
.bullet-outline-rail {
  position: fixed;
  z-index: var(--outline-z);
  inset-inline-end: 0;
  top: var(--outline-top, var(--outline-sticky-top));
  width: var(--outline-rail-width);
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  transition: opacity 0.12s ease;
  pointer-events: auto; /* interactive */
  background-color: var(--outline-rail-fill);
}

/* Remove any default focus ring around the rail container itself */
.bullet-outline-rail:focus,
.bullet-outline-rail:focus-visible,
.bullet-outline-rail:focus-within {
  outline: none;
  box-shadow: none;
}

.bullet-outline-rail-bars {
  display: flex;
  flex-direction: column;
  gap: var(--outline-rail-gap);
  padding-inline-end: var(--outline-rail-pad-right);
  padding-bottom: var(--outline-rail-gap);
  /* Pre-allocate space to avoid layout shift on hover and focus */
  padding-top: var(--outline-rail-gap);
  /* match bottom */
  padding-inline-start: var(--outline-rail-gap);
  /* left padding in default state */
  border-top: var(--outline-rail-border-w) solid var(--outline-rail-border-color);
  border-left: var(--outline-rail-border-w) solid var(--outline-rail-border-color);
  border-bottom: var(--outline-rail-border-w) solid var(--outline-rail-border-color);
  border-right: 0;
  border-top-left-radius: var(--outline-rail-tab-radius);
  border-bottom-left-radius: var(--outline-rail-tab-radius);
  transition: background-color 0.18s ease, border-color 0.18s ease;
}

.bullet-outline-bar {
  height: var(--outline-rail-bar-height);
  background-color: var(--outline-rail-muted);
  border-radius: var(--outline-rail-bar-height);
  transition: background 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
  transform-origin: right center;
}

/* Width + indent by level (approximate Notion look) */
.bullet-outline-bar.level-1 {
  width: var(--outline-rail-bar-full-width);
  margin-inline-start: 0;
}
.bullet-outline-bar.level-2 {
  width: calc(var(--outline-rail-bar-full-width) * 0.75); /* default 12px */
  margin-inline-start: calc(var(--outline-rail-bar-full-width) * 0.25); /* default 4px */
}
.bullet-outline-bar.level-3 {
  width: calc(var(--outline-rail-bar-full-width) * 0.5); /* default 8px */
  margin-inline-start: calc(var(--outline-rail-bar-full-width) * 0.5); /* default 8px */
}

/* Active bar emphasizes current section */
.bullet-outline-bar.active {
  background-color: var(--outline-rail-active);
}

/* On rail focus, apply highlight and subtly lengthen bars to suggest “pull-out”. */
.bullet-outline-rail:focus-within .bullet-outline-rail-bars {
  background-color: var(--outline-rail-fill-hover);
  border-color: var(--outline-rail-border-color-hover);
}

.bullet-outline-rail:focus-within .bullet-outline-bar {
  transform: scaleX(1.25);
}

/* Popup container (hidden by default; shown via .open class) */
.bullet-outline-popup {
  position: fixed;
  z-index: calc(var(--outline-z) + 1);
  inset-inline-end: var(--outline-popup-right-offset);
  top: var(--outline-top, var(--outline-sticky-top));
  width: var(--outline-popup-width);
  /* Ensure popup never extends below viewport: cap by remaining space below dynamic top */
  max-height: min(var(--outline-popup-max-h), calc(100vh - var(--outline-top, var(--outline-sticky-top)) - 12px));
  background-color: var(--outline-bg);
  color: var(--outline-fg);
  border-radius: var(--outline-card-radius);
  box-shadow: var(--outline-shadow-1), var(--outline-shadow-2), var(--outline-border) 0 0 0 1px;
  overflow: auto;
  /* Prevent scroll chaining to page when reaching top/bottom */
  overscroll-behavior: contain;
  display: none;
  pointer-events: auto; /* interactive */

  /* Subtle, theme-aware scrollbar (Firefox + generic) */
  scrollbar-width: thin;
  scrollbar-color: var(--outline-scrollbar-thumb) transparent;
}

/* Prefer dynamic viewport units when available */
@supports (height: 100dvh) {
  .bullet-outline-popup {
    max-height: min(var(--outline-popup-max-h), calc(100dvh - var(--outline-top, var(--outline-sticky-top)) - 12px));
  }
}

/* Visible when JS toggles it */
.bullet-outline-popup.open {
  display: block;
}

/* When popup is open, fade the rail out (Notion-like) */
.bullet-outline-rail:has(+ .bullet-outline-popup.open) {
  opacity: 0;
}

/* Inner list */
.bullet-outline-list {
  padding: var(--outline-popup-pad-top) var(--outline-popup-pad-x) var(--outline-popup-pad-bottom)
    var(--outline-popup-pad-x);
  display: flex;
  flex-direction: column;
  gap: var(--outline-popup-gap);
}

/* Item link */
.bullet-outline-item {
  display: block;
  color: var(--outline-fg);
  text-decoration: none;
  user-select: none;
  cursor: pointer;
  padding: var(--outline-item-padding);
  transition: color 0.15s ease, background-color 0.15s ease;
  border-radius: var(--outline-item-border-radius);
}

.bullet-outline-item .title {
  line-height: 1.3;
  font-size: var(--outline-item-font-size);
  /* clamp to two lines */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  overflow: hidden;
  -webkit-line-clamp: 2;
  line-clamp: 2;
}

/* Indentation by level */
.bullet-outline-item.level-1 {
  margin-inline-start: 0;
}
.bullet-outline-item.level-2 {
  margin-inline-start: var(--outline-level-indent);
}
.bullet-outline-item.level-3 {
  margin-inline-start: calc(var(--outline-level-indent) * 2);
}

/* Active/current section in popup */
.bullet-outline-item.active {
  color: var(--outline-accent);
  background-color: transparent;
}

/* Hover/focus (gray background; don't change text color) */
.bullet-outline-item:hover,
.bullet-outline-item:focus {
  background-color: var(--outline-hover-bg);
  outline: none;
}

/* Accessibility focus ring */
.bullet-outline-item:focus-visible {
  outline: var(--outline-focus-outline);
  background: transparent;
}

/* Utility: hidden state if outline not applicable (e.g., too few headings) */
.bullet-outline-hidden {
  display: none !important;
}
/* Dark-mode specific active item styling in popup (Notion-like "pill") */
.dark-mode .bullet-outline-item.active:hover,
.dark-mode .bullet-outline-item.active:focus {
  background-color: rgba(255, 255, 255, 0.14);
}

/* SUBSECTION: Fullscreen presentation for touch/coarse devices */
/* Close button is hidden by default; shown only on touch/coarse media */
.bullet-outline-close {
  display: none;
}

body.dsbullet-mobile-popup {
  /* Expand popup to cover viewport; keep same DOM and behavior */
  .bullet-outline-popup.open {
    inset: 0;
    top: 0;
    inset-inline: 0;
    width: 100vw;
    height: 100vh; /* fallback for browsers without dvh */
    max-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* Close button (only visible on touch/coarse) */
  .bullet-outline-close {
    display: inline-flex;
    flex: 0 0 auto;
    align-items: center;
    justify-content: center;
    align-self: flex-end;
    appearance: none;
    border: none;
    margin: 8px;
    font-size: 26px;
    line-height: 1;
    width: 44px;
    height: 44px;
    border-radius: var(--outline-item-border-radius);
    cursor: pointer;
  }

  .bullet-outline-close:focus-visible {
    outline: var(--outline-focus-outline);
  }

  /* Make the list fill and scroll within fullscreen */
  .bullet-outline-list {
    padding: var(--outline-popup-pad-top) var(--outline-popup-pad-x) var(--outline-popup-pad-bottom-mobile)
      var(--outline-popup-pad-x);
    flex: 0 0 auto; /* don't sqish items, scroll instead */
    overflow: auto;
    /* Add a bit of separation between items for touch */
    gap: var(--outline-popup-gap-mobile);
  }

  /* Hide the rail while modal list is open on touch devices */
  .bullet-outline-rail:has(+ .bullet-outline-popup.open) {
    opacity: 0;
    pointer-events: none;
  }

  /* Larger, accessible tap targets in fullscreen */
  .bullet-outline-item {
    padding: var(--outline-item-padding-mobile);
    min-height: 44px; /* iOS HIG minimum */
  }

  /* Larger, more legible titles on mobile */
  .bullet-outline-item .title {
    font-size: clamp(16px, 4.4vw, 18px);
    line-height: 1.4;
  }

  @supports (height: 100dvh) {
    .bullet-outline-popup.open {
      height: 100dvh;
      max-height: 100dvh;
    }
  }
}

/* Prevent background scroll when popup is open */
html:has(body.dsbullet-mobile-popup .bullet-outline-popup.open),
body.dsbullet-mobile-popup:has(.bullet-outline-popup.open) {
  overflow: hidden;
  /* Allow pinch-zoom while preventing background page panning */
  touch-action: pinch-zoom;
}

/* SUBSECTION: Accessibility and Compatibility */
/* Reduced motion considerations */
@media (prefers-reduced-motion: reduce) {
  .bullet-outline-bar,
  .bullet-outline-item {
    transition: none;
  }
  .bullet-outline-rail:focus-within .bullet-outline-bar {
    transform: none;
  }
}

/* WebKit scrollbar styling for the popup (theme-aware via CSS variables) */
.bullet-outline-popup::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}
.bullet-outline-popup::-webkit-scrollbar-track {
  background: transparent;
}
.bullet-outline-popup::-webkit-scrollbar-thumb {
  background-color: var(--outline-scrollbar-thumb);
  border-radius: var(--outline-item-border-radius);
  border: 2px solid transparent; /* creates padding for the thumb */
  background-clip: padding-box;
}
.bullet-outline-popup::-webkit-scrollbar-thumb:hover {
  background-color: var(--outline-scrollbar-thumb-hover);
}

/* ---------------------------------------------- */
/* **** END OF: Notion-like Floating Outline **** */
/* ---------------------------------------------- */
